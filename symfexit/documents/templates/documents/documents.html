{% extends "menupage.html" %}
{% load i18n l10n static %}

{% block css %}
<link href="{% static "css/filepond.css" %}" rel="stylesheet">
<style>
  .filepond--root {
    min-width: 200px;
    flex: 1 1 0%; /* Take up remaining space in flex container */
  }
</style>
{% endblock css %}
{% block main %}
<div class="container mx-auto pt-8 p-2">
  <h1 class="font-header text-5xl mb-6">{% translate 'Documents' %}</h1>
  <div class="flex flex-row flex-wrap justify-between items-center mb-4">
    <div class="flex flex-row items-center gap-2">
      {% include "documents/breadcrumbs.html" %}
    </div>
    <div class="flex flex-row gap-4">
      {% if has_add_directory_permission %}
      <button
        popovertarget="new-folder-popover"
        class="border text-primary p-3 cursor-pointer flex gap-2 items-center transition-color duration-200 ease-in"
        type="button"
      >
        <i class="fa-solid fa-folder"></i>{% translate 'New directory' %}
      </button>
      <dialog id="new-folder-popover" popover class="backdrop:bg-gray-50/50 m-auto p-4 bg-white border rounded shadow-lg min-w-xs max-w-lg w-full starting:open:opacity-0 open:opacity-100 transition-opacity duration-200 ease-in transition-discrete">
        <form class="flex md:flex-row md:items-top gap-4 flex-wrap items-start" action="{% url 'documents:create-directory' %}" method="POST">
          {% csrf_token %}
          <input type="text" name="name" id="new-folder-name" class="border p-2 flex-grow" placeholder="{% translate 'Name of the directory' %}" required>
          <input type="hidden" name="parent_id" value="{% if parent %}{{ parent.id }}{% endif %}">
          <button type="submit" id="create-folder-btn" class="bg-primary text-white p-2 cursor-pointer">{% translate 'Create directory' %}</button>
        </form>
      </dialog>
      {% endif %}
      {% if has_add_file_permission %}
      <button
        popovertarget="upload-popover"
        class="border text-primary p-3 cursor-pointer flex gap-2 items-center"
        type="button"
      >
        <i class="fa-solid fa-upload"></i>{% translate 'Upload' %}
      </button>
      <dialog id="upload-popover" popover class="max-h-lvh m-4 backdrop:bg-gray-50/50 m-auto p-4 bg-white border rounded shadow-lg min-w-xs max-w-lg w-full starting:open:opacity-0 open:opacity-100 transition-opacity duration-200 ease-in transition-discrete">
        <form class="flex md:flex-row md:items-top gap-4 flex-wrap items-start" action="{% url 'documents:upload' %}" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" name="filepond" multiple class="filepond">
          <input type="hidden" name="parent_id" value="{% if parent %}{{ parent.id }}{% endif %}">
          <input type="submit" id="do-upload-btn" class="bg-primary text-white p-2 cursor-pointer h-fit flex-shrink-0 w-full sm:w-auto disabled:bg-primary/50" value="{% translate 'Add' %}">
        </form>
      </dialog>
      {% endif %}
    </div>
  </div>
  <table class="w-full border border-gray-300">
    <colgroup>
      <col span="2">
      <col class="w-1/5">
      <col class="w-1/5">
    </colgroup>
    <thead>
      <tr class="border-b border-gray-300">
        <th class="border-l border-t border-gray-300" onclick="window.location.href='{{ name_url }}'"></th>
        <th class="py-3 pl-1 pr-4 text-left text-primary border-r border-t border-gray-300" onclick="window.location.href='{{ name_url }}'">
          <div class="flex flex-row items-center gap-1 place-content-between">
            <a href="{{ name_url }}" class="{% if '-name' in sorting_query or sorting_query == '' %}font-bold{% else %}font-normal{% endif %}">{% translate 'Name' %}</a>
            {% if '-name' in sorting_query %}
            <i class="fa fa-chevron-down"></i>
            {% elif sorting_query == '' %}
            <i class="fa fa-chevron-up"></i>
            {% endif %}
          </div>
        </th>
        <th class="py-3 pl-1 pr-4 border-t border-r border-gray-300 py-3 pl-3 text-left text-primary" onclick="window.location.href='{{ size_url }}'">
          <div class="flex flex-row items-center gap-1 place-content-between">
            <a href="{{ size_url }}" class="{% if 'size' in sorting_query %}font-bold{% else %}font-normal{% endif %}">{% translate 'Size' %}</a>
            {% if '-size' in sorting_query %}
            <i class="fa fa-chevron-down"></i>
            {% elif 'size' in sorting_query %}
            <i class="fa fa-chevron-up"></i>
            {% endif %}
          </div>
        </th>
        <th class="py-3 pl-1 pr-4  border-t border-r border-gray-300 py-3 pl-3 text-left text-primary" onclick="window.location.href='{{ created_at_url }}'">
          <div class="flex flex-row items-center gap-1 place-content-between">
            <a href="{{ created_at_url }}" class="{% if 'created_at' in sorting_query %}font-bold{% else %}font-normal{% endif %}">{% translate 'Date' %}</a>
            {% if '-created_at' in sorting_query %}
            <i class="fa fa-chevron-down"></i>
            {% elif 'created_at' in sorting_query %}
            <i class="fa fa-chevron-up"></i>
            {% endif %}
          </div>
        </th>
      </tr>
    </thead>
    <tbody>
      {% comment %} parent (current) directory has it's own parent {% endcomment %}
      {% if parent.parent %}
        <tr class="even:bg-gray-100 odd:bg-white" onclick="window.location.href='{% url "documents:documents" parent.parent.id %}{{ sorting_query }}'">
          <td class="py-3 pl-3 pr-1 w-1 text-center"><i class="text-center flex fa-solid fa-folder-minus text-primary"></i></td>
          <td class="py-3 px-1"><a href="{% url "documents:documents" parent.parent.id %}{{ sorting_query }}">{% translate '.. (parent directory)' %}</a>
            <td class="py-3 px-1"></td><td class="py-3 px-1"></td>
          </td>
        </tr>
      {% comment %} parent (current) directory is the toplevel {% endcomment %}
      {% elif parent %}
        <tr class="even:bg-gray-100 odd:bg-white" onclick="window.location.href='{% url "documents:documents" %}{{ sorting_query }}'">
          <td class="py-3 pl-3 pr-1 w-1 text-center"><i class="text-center flex fa-solid fa-folder-minus text-primary"></i></td>
          <td class="py-3 px-1"><a href="{% url "documents:documents" %}{{ sorting_query }}">{% translate '.. (parent directory)' %}</a>
            <td class="py-3 px-1"></td><td class="py-3 px-1"></td>
          </td>
        </tr>
      {% endif %}
    {% comment %} First show all the directories {% endcomment %}
    {% for document in directories %}
      <tr class="even:bg-gray-100 odd:bg-white" onclick="window.location.href='{% url "documents:documents" document.id %}{{ sorting_query }}'">
        <td class="py-3 pl-3 pr-1 w-1 text-center"><i class="text-center flex fa-regular fa-folder-open text-primary"></i></td>
        <td class="py-3 pl-1 pr-1 "><a href="{% url "documents:documents" document.id %}{{ sorting_query }}">{{ document.name }}</a>
          <td class="py-3 pl-3 pr-1">
            {% if document.size == 1 %}
              {{ document.size }} {% translate 'item' %}
            {% else %}
              {{ document.size }} {% translate 'items' %}
            {% endif %}
          </td><td class="py-3 pl-3 pr-1 ">
              {{ document.created_at|date:"DATE_FORMAT" }}
          </td>
        </td>
      </tr>
    {% endfor %}
    {% comment %} Then show all the files {% endcomment %}
    {% for file in files %}
      <tr class="even:bg-gray-100 odd:bg-white" onclick="window.location.href='{% url "documents:file" file.id %}{{ sorting_query }}'">
        <td class="py-3 pl-3 pr-1 w-1 text-center"><i class="text-center flex fa-regular fa-file text-primary"></i></td>
        <td class="py-3 px-1">
          <a href="{% url "documents:file" file.id %}{{ sorting_query }}">{{ file.name }}</a>
        </td>
        <td class="py-3 pl-3 pr-1">{{ file.human_size }}</td>
        <td class="py-3 pl-3 pr-1">{{ file.created_at|date:"DATE_FORMAT"}}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock main %}
{% block scripts %}
<script src="{% static "js/filepond.js" %}"></script>
<script>
  FilePond.setOptions({
    chunkUploads: true,
    chunkSize: 500000,
    dropOnPage: true,
    credits: false,
    server: {
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      url: '/fp',
      process: '/process/',
      patch: '/patch/',
      revert: '/revert/',
      fetch: '/fetch/?target='
    }
  });
  const input = document.querySelector('input[type="file"]');
  const pond = FilePond.create(input);

  const $addBtn = document.getElementById('do-upload-btn');

  // Disable button while FilePond is busy
  pond.on('processfile', () => {
    if (pond.getFiles().some(f => f.status !== FilePond.FileStatus.PROCESSING_COMPLETE)) {
      $addBtn.disabled = true;
    }
  });

  pond.on('processfilestart', () => {
    $addBtn.disabled = true;
  });

  pond.on('processfileprogress', () => {
    $addBtn.disabled = true;
  });

  pond.on('processfileabort', () => {
    $addBtn.disabled = false;
  });

  pond.on('processfileundo', () => {
    $addBtn.disabled = false;
  });

  pond.on('processfiles', () => {
    $addBtn.disabled = false;
  });

  pond.on('addfile', () => {
    // If any file is still processing, disable
    if (pond.getFiles().some(f => f.status === FilePond.FileStatus.PROCESSING || f.status === FilePond.FileStatus.PROCESSING_QUEUED)) {
      $addBtn.disabled = true;
    }
  });

  pond.on('removefile', () => {
    // Enable if no files are processing
    if (!pond.getFiles().some(f => f.status === FilePond.FileStatus.PROCESSING || f.status === FilePond.FileStatus.PROCESSING_QUEUED)) {
      $addBtn.disabled = false;
    }
  });

  $addBtn.disabled = false;

  document.querySelectorAll('tr[onclick]').forEach(row => {
    row.classList.add('cursor-pointer');
  });
  document.querySelectorAll('th[onclick]').forEach(row => {
    row.classList.add('cursor-pointer');
  });
</script>
{% endblock scripts %}
